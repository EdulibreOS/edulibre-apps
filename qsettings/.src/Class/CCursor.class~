' Gambas class file

' Gambas class file

Public Struct Header
  magic[4] As Byte
  header As Integer
  version As Integer
  ntoc As Integer
End Struct

Public Struct Toc
  type As Integer ' entry type
  subtype As Integer ' type - specific label - size For images
  position As Integer ' absolute byte position Of table In file
  
End Struct

Public Struct ChunkImage
  header As Integer ' bytes In chunk header(including type - specific fields)
  type As Integer ' must Match type In TOC For this chunk
  subtype As Integer ' must Match subtype In TOC For this chunk
  version As Integer ' version number For this chunk type
  width As Integer ' Must be less than Or equal To 0 x7fff
  height As Integer ' Must be less than Or equal To 0 x7fff
  xhot As Integer ' Must be less than Or equal To width
  yhot As Integer ' Must be less than Or equal To height
  delay As Integer ' Delay between animation frames In milliseconds
End Struct

''Store the images
Private $aImages As New Image[]

Property Read Count As Integer ''Return the images count

Public Sub _new(Path As String)
  
  Dim hHeader As Header
  Dim hFile As File
  Dim aToc As New Toc[]
  Dim hToc As Toc
  Dim i, j As Integer
  Dim aImage As New Integer[]
  Dim hChunkImage As ChunkImage
  Dim iPictureSize As Integer
  Dim hImage As Image
  
  hFile = Open Path For Read
  
  hHeader = Read #hFile As Header
  
  If hHeader.magic.ToString() <> "Xcur" Then Error.Raise("Invalid cursor file")
  
  For i = 1 To hHeader.ntoc
    hToc = Read #hFile As Toc
    If hToc.type = &Hfffd0002 Then 
      
      aToc.Add(hToc)
      
    Endif
  Next
  
  For Each hToc In aToc
    
    Seek #hFile, hToc.position
    hChunkImage = Read #hFile As ChunkImage
    iPicturesize = hChunkImage.width * hChunkImage.height
    
    For i = 0 To iPictureSize - 1
      
      j = Read #hFile As Integer
      aImage.Add(j)
    Next
    hImage = New Image(hChunkImage.width, hChunkImage.height, Color.Transparent, Image.Premultiplied)
    hImage.Pixels = aImage
    $aImages.Add(hImage)
    
    aImage.Clear
    
  Next
  
End

Private Function Count_Read() As Integer
  
  Return $aImages.Count
  
End

Public Function _get(Index As Integer) As Picture
  
  Return $aImages[Index].Picture
  
End
