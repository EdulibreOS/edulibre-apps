' Gambas class file

Public cx As New Connection
'Public cx1 As New Connection
Public rs As Result
Public rs1 As Result
Public rs2 As Result
Public hGetFileClient As New HttpClient As "hGetFileClient" Private sDownloadBuffer As String
Private sNameTheme As String
Private sCodTheme As Integer

Public Sub _new()
  
  cx = M_DB.Connect()
  rs = cx.Exec("select * from tbDat LIMIT 20")
  
  'cx1 = M_DB.Connect_Wall()
  ' rs1 = cx1.Exec("select * from tb_wallpaper")
  
  Grid.Columns.Count = 1
  Grid.Rows.Height = 100
  Grid.columns[0].text = "Item Name"  
  Grid.columns[0].width = 350  
  Grid.columns[0].resizable = False  
  Grid.Rows.Count = rs.Count 
  
  DownloadFile
  
End

Public Sub FillsList()
  
  Grid.data.RichText = "<b><u><font color=#005FBF>" & rs!Name & "</u></b>"
  Grid.data.RichText &= "<br><font size=-1>" & "By " & rs!By & "</font>"
  Grid.data.RichText &= "<br><font size=-1>" & rs!Info & "</font>"
  Grid.data.RichText &= "<br><font size=-1>" & rs!Download & " Downloads" & "</font>"
  Grid.Data.Picture = Picture[User.Home &/ rs!Cod & ".png"].Image.Stretch(92, 52).Picture
Catch
  
End

Public Sub FillsList2()
  
  ' Print sCodTheme
  'rs2 = cx.Exec("SELECT * FROM tbDat where Name LIKE '%" & txtSearch.Text & "%'")
  ' rs2 = cx.Exec("SELECT * FROM tbDat where Name LIKE '%" & txtSearch.Text & "%'")
  rs2 = cx.Exec("SELECT * FROM tbDat where Name LIKE '%" & txtSearch.Text & "%' LIMIT 20")
  
  Grid.Columns.Count = 1
  Grid.Rows.Height = 100
  'Grid.columns[0].text = "Item Name"  
  Grid.columns[0].width = 350  
  Grid.columns[0].resizable = False  
  Grid.Rows.Count = rs2.Count 
  
  ' sCodTheme = rs2!Cod
  
  Grid.data.RichText = "<b><u><font color=#005FBF>" & rs2!Name & "</u></b>"
  Grid.data.RichText &= "<br><font size=-1>" & "By " & rs2!By & "</font>"
  Grid.data.RichText &= "<br><font size=-1>" & rs2!Info & "</font>"
  Grid.data.RichText &= "<br><font size=-1>" & rs2!Download & " Downloads" & "</font>"
  Try Grid.Data.Picture = Picture[User.Home &/ rs2!Cod & ".png"].Image.Stretch(92, 52).Picture
  'PictureBox1.Picture = Picture[User.Home &/ rs2!Cod & ".png"]
  
Catch
  
End

Public Sub Grid_Draw(X As Integer, Y As Integer, Width As Integer, Height As Integer, Row As Integer, Column As Integer)
  
  rs.moveTo(row)
  
  If IsNull(txtSearch.Text) Then 
    FillsList
    
  Else
    FillsList2
  Endif
  
End

Public Sub DownloadFile()
  
  Dim i As Integer
  
  Do While rs.Available 
    Inc i
    
    hGetFileClient.URL = rs!Screenshot
    hGetFileClient.TimeOut = 0
    hGetFileClient.Async = True
    hGetFileClient.Get([], User.Home &/ rs!Cod & ".png")
    
    ' Wait 2
    'ListViewImage.Add(rs!Name, rs!Name, Picture[User.Home &/ "test" & i & ".png"].Image.Stretch(128, 72).Picture)
    Print rs!Screenshot
    rs.MoveNext 
    
  Loop 
Catch
  
End

Public Sub hGetFileClient_connect()
  
  ' Message("Started")
  BtnInstall.Text = "Install"
  
End 

Public Sub hGetFileClient_Error()
  
  hGetFileClient.Stop()
  Message("error")
  
End

Public Sub hGetFileClient_Finished()
  
  hGetFileClient.Stop()
  ' Message("done")
  'Catch
  
End 

Public Sub Grid_Change001()
  
  Dim i As Integer = Last.row + 1
  
  ' rs1 = cx.Exec("SELECT * FROM tbDat where id LIKE '" & i & "'")
  'PictureBox1.Picture = Picture[User.Home &/ rs1!Cod & ".png"]
  'sNameTheme = rs1!Name
  'Print sNameTheme
  
  ' rs2 = cx1.Exec("SELECT * FROM tb_wallpaper where Name LIKE '" & sNameTheme & "'")
  
  If rs.Count = 0 Then 
    BtnInstall.Enabled = True
    BtnInstall.Text = "&Install"
    BtnInstall.Picture = Picture["icon:/small/ok"]
  Else 
    
    'BtnInstall.Enabled = False 
    BtnInstall.Text = "&Delete"
    BtnInstall.Picture = Picture["icon:/small/delete"]
  Endif
  
End

Public Sub BtnInstall_Click()
  
  ProgressBar1.Value = 0
  hGetFileClient_Progress
  '  DownloadFile
  
End

Public Sub hGetFileClient_Progress()
  
  ' ProgressBar1.Value = hGetFileClient.Downloaded / hGetFileClient.TotalDownloaded
  'Catch
  
End

Public Sub Grid_Change()
  
  Dim i As Integer = Last.row + 1
  
  ' If Not IsNull(txtSearch.Text) Then 
  '   rs1 = cx.Exec("SELECT * FROM tbDat where Name LIKE '%" & txtSearch.Text & "%'")
  '   Print sCodTheme
  '   Print rs1!Cod
  '   PictureBox1.Picture = Picture[User.Home &/ sCodTheme & ".png"]
  ' Endif
  
  If IsNull(txtSearch.Text) Then 
    rs1 = cx.Exec("SELECT * FROM tbDat where id LIKE '" & i & "'")
    PictureBox1.Picture = Picture[User.Home &/ rs1!Cod & ".png"]
  Else
    
    ' rs2 = cx.Exec("SELECT * FROM tbDat where Name LIKE '%" & txtSearch.Text & "%'")
    rs2 = cx.Exec("SELECT * FROM tbDat where id LIKE '" & sCodTheme & "'")
    'sCodTheme = rs2!Cod
    PictureBox1.Picture = Picture[User.Home &/ rs2!Cod & ".png"]
    
  Endif
  
  'If Not IsNull(txtSearch.Text) Then 
  '  
  '  rs = cx.Exec("SELECT * FROM tbDat where id LIKE '" & sCodTheme & "'")
  '  Print Picture[User.Home &/ sCodTheme & ".png"]
  '  PictureBox1.Picture = Picture[User.Home &/ sCodTheme & ".png"]
  '  
  'Endif
  
  ' Try Grid.Data.Picture = Picture[User.Home &/ rs1!Cod & ".png"].Image.Stretch(92, 52).Picture
  
  'rs1 = cx.Exec("SELECT * FROM tbDat where Name LIKE '%" & txtSearch.Text & "%'")
  
End

Public Sub txtSearch_Change()
  
  rs2 = cx.Exec("SELECT * FROM tbDat where Name LIKE '%" & txtSearch.Text & "%'")
  sCodTheme = rs2!Cod
  Print sCodTheme
  ' Print sCodTheme
  FillsList2
  
End

Public Sub Form_Open()
  
End

Public Sub Grid_Click()
  
End
